"use strict";(self["webpackChunkmyblog"]=self["webpackChunkmyblog"]||[]).push([[897],{2897:function(s,t,r){r.r(t),r.d(t,{default:function(){return j}});var a=function(){var s=this,t=s._self._c;return t("div",[t("el-card",{staticStyle:{background:"rgba(255, 255, 255, 0.5)"}},[t("div",{staticClass:"markdown-body"},[t("blog-tags",{scopedSlots:s._u([{key:"footer",fn:function(){return[t("div",[s._v("test")]),t("button",[s._v("footer")])]},proxy:!0}])})],1)])],1)},e=[],n=function(){var s=this;s._self._c;return s._m(0)},l=[function(){var s=this,t=s._self._c;return t("article",[t("html",[t("head"),t("body",[t("hr"),t("p",[s._v("title: 关于用户token的处理 date: 2022-10-26 10:02:33 categories: 黑马头条项目 tags:")]),t("ul",[t("li",[s._v("项目总结")]),t("li",[s._v("vue")]),t("li",[s._v("token")])]),t("hr"),t("h2",[t("strong",[s._v("处理用户 Token")])]),t("p",[t("code",{pre:!0},[s._v("Token")]),s._v("是用户登录成功后服务端返回的一个身份令牌，在项目中的多个业务中需要使用到:")]),t("ul",[t("li",[s._v("访问需要授权的API")]),t("li",[s._v("校验页面的访问权限")]),t("li",[s._v("...")])]),t("p",[s._v("但是我们只有在第一次用户登录成功之后才能拿到"),t("code",{pre:!0},[s._v("Token")]),s._v("。 所以为了能在其它模块中获取到"),t("code",{pre:!0},[s._v("Token")]),s._v("数据，我们需要把它存储到一个公共的位置，方便随时取用。 往哪儿存？")]),t("ul",[t("li",[s._v("本地储存 "),t("ul",[t("li",[s._v("获取麻烦")]),t("li",[s._v("数据不是响应式")])])]),t("li",[s._v("Vuex容器（推荐） "),t("ul",[t("li",[s._v("获取方便")]),t("li",[s._v("响应式的")])])])]),t("p",[s._v("使用容器存储"),t("code",{pre:!0},[s._v("Token")]),s._v("的思路：")]),t("p",[t("img",{attrs:{src:r(3292),alt:"容器存储Token"}})]),t("ul",[t("li",[s._v("登录成功后，将"),t("code",{pre:!0},[s._v("Token")]),s._v("存储到"),t("code",{pre:!0},[s._v("Vuex")]),s._v("容器中 "),t("ul",[t("li",[s._v("获取方便")]),t("li",[s._v("响应式")])])]),t("li",[s._v("为了持久化，还需要把"),t("code",{pre:!0},[s._v("Token")]),s._v("存到本地储存 "),t("ul",[t("li",[s._v("持久化")])])])]),t("p",[s._v("下面是具体实现")]),t("p",[s._v("1、在"),t("code",{pre:!0},[s._v("src/store/index.js")]),s._v("中")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Vue")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'vue'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Vuex")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'vuex'")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Vue")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("use")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Vuex")]),s._v(")\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("default")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Vuex")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Store")]),s._v("({\n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("state")]),s._v(":{\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 用户登录的状态信息")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("user")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("JSON")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("parse")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("window")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("localStorage")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("getItem")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"TOUTIAO_USER"')]),s._v("))\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// user: null")]),s._v("\n    },\n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("mutations")]),s._v(": {\n        setUser (state, user) {\n            state."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("user")]),s._v(" = user\n            "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("window")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("localStorage")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("setItem")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'TOUTIAO_USER'")]),s._v(","),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("JSON")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("stringify")]),s._v("(user))\n        }\n    },\n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("action")]),s._v(": {\n\n    },\n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("modules")]),s._v(": {\n\n    }\n})\n")])]),t("p",[s._v("2、登录成功以后将后端返回的 token 相关数据存储到容器中")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("async")]),s._v(" onLogin () {\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("this")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("$toast")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("loading")]),s._v("({\n        "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("duration")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 持续时间，0表示持续展示不停止")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("forbidClick")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 是否禁止背景点击")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("message")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'登录中...'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 提示消息")]),s._v("\n    })\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("try")]),s._v("{\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" res = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("await")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("login")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("this")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("user")]),s._v(")\n        "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("this")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("$store")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("commit")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'setUser'")]),s._v(",res."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v(")\n        "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("this")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("$toast")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("success")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'登陆成功'")]),s._v(")\n    } "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("catch")]),s._v(" (err) {\n        "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'登录失败'")]),s._v(", err)\n        "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("this")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("$toast")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("fail")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'登录失败，手机号或验证码错误'")]),s._v(")\n    }\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 停止 loading，它会把当前页面中所有的 toast 都给清除")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// loginToast.clear()")]),s._v("\n}\n")])]),t("h2",[t("strong",[s._v("优化封装本地存储操作模块")])]),t("p",[s._v("创建"),t("code",{pre:!0},[s._v("src/utils/storage.js")]),s._v("模块。")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("getItem")]),s._v(" = name => {\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" data = "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("window")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("localStorage")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("getItem")]),s._v("(name)\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("try")]),s._v("{\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("JSON")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("parse")]),s._v("(data)\n    } "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("catch")]),s._v(" (err) {\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" data\n    }\n}\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("setItem")]),s._v(" = ("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("name, value")]),s._v(") => {\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("typeof")]),s._v(" value === "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'object'")]),s._v(") {\n        value = "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("JSON")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("stringify")]),s._v("(value)\n    }\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("window")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("localStorage")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("setItem")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'name'")]),s._v(",value)\n}\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("removeItem")]),s._v(" = name => {\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("window")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("localStorage")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("removeItem")]),s._v("(name)\n}\n")])]),t("h2",[t("strong",[s._v("关于 Token 过期问题")])]),t("p",[s._v("登录成功之后后端会返回两个 Token：")]),t("ul",[t("li",[t("code",{pre:!0},[s._v("token")]),s._v("：访问令牌，有效期2小时")]),t("li",[t("code",{pre:!0},[s._v("refresh_token")]),s._v("：刷新令牌，有效期14天，用于访问令牌过期之后重新获取新的访问令牌")])]),t("p",[s._v("我们的项目接口中设定的 "),t("code",{pre:!0},[s._v("Token")]),s._v(" 有效期是 "),t("code",{pre:!0},[s._v("2 小时")]),s._v("，超过有效期服务端会返回 "),t("code",{pre:!0},[s._v("401")]),s._v(" 表示 Token 无效或过期了。")]),t("p",[s._v("为什么过期时间这么短？")]),t("ul",[t("li",[s._v("为了安全，例如 Token 被别人盗用")])]),t("p",[s._v("过期了怎么办？")]),t("ul",[t("li",[t("s",[s._v("让用户重新登录")]),s._v("，用户体验太差了")]),t("li",[s._v("使用"),t("code",{pre:!0},[s._v("refresh-token")]),s._v("解决"),t("code",{pre:!0},[s._v("token")]),s._v("过期")])]),t("p",[s._v("如何使用 "),t("code",{pre:!0},[s._v("refresh_token")]),s._v(" 解决 "),t("code",{pre:!0},[s._v("token")]),s._v(" 过期？")]),t("p",[s._v("到课程的后面我们开发的业务功能丰富起来之后，再给大家讲解 Token 过期处理。")]),t("p",[s._v("大家需要注意的是"),t("strong",[s._v("在学习测试的时候如果收到 401 响应码，请重新登录再测试")]),s._v("。")]),t("p",[s._v("概述：服务器生成"),t("code",{pre:!0},[s._v("token")]),s._v("的过程中，会有两个时间，一个是"),t("code",{pre:!0},[s._v("token")]),s._v("失效时间，一个是"),t("code",{pre:!0},[s._v("token")]),s._v("刷新时间，刷新时间肯定比失效时间长，当用户的 "),t("code",{pre:!0},[s._v("token")]),s._v(" 过期时，你可以拿着过期的"),t("code",{pre:!0},[s._v("token")]),s._v("去换取新的"),t("code",{pre:!0},[s._v("token")]),s._v("，来保持用户的登陆状态，当然你这个过期"),t("code",{pre:!0},[s._v("token")]),s._v("的过期时间必须在刷新时间之内，如果超出了刷新时间，那么返回的依旧是 401。")]),t("p",[s._v("处理流程:")]),t("ol",[t("li",[s._v("在axios的拦截器中加入token刷新逻辑")]),t("li",[s._v("当用户token过期时，去向服务器请求新的 token")]),t("li",[s._v("把旧的token替换为新的token")]),t("li",[s._v("然后继续用户当前的请求")])]),t("p",[s._v("在请求的响应拦截器中统一处理 token 过期：")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/**\n * 封装 axios 请求模块\n */")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("import")]),s._v(" axios "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"axios"')]),s._v(";\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("import")]),s._v(" jsonBig "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"json-bigint"')]),s._v(";\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("import")]),s._v(" store "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"@/store"')]),s._v(";\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("import")]),s._v(" router "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("from")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"@/router"')]),s._v(";\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// axios.create 方法：复制一个 axios")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" request = axios."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("create")]),s._v("({\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("baseURL")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"http://ttapi.research.itcast.cn/"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 基础路径")]),s._v("\n});\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("/**\n * 配置处理后端返回数据中超出 js 安全整数范围问题\n */")]),s._v("\nrequest."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("defaults")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("transformResponse")]),s._v(" = [\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("data")]),s._v(") {\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("try")]),s._v(" {\n      "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" jsonBig."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("parse")]),s._v("(data);\n    } "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("catch")]),s._v(" (err) {\n      "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" {};\n    }\n  }\n];\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 请求拦截器")]),s._v("\nrequest."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("interceptors")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("request")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("use")]),s._v("(\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("config")]),s._v(") {\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" user = store."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("state")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("user")]),s._v(";\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (user) {\n      config."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("headers")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("Authorization")]),s._v(" = "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("`Bearer "),t("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${user.token}")]),s._v("`")]),s._v(";\n    }\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Do something before request is sent")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" config;\n  },\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("error")]),s._v(") {\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Do something with request error")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Promise")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("reject")]),s._v("(error);\n  }\n);\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 响应拦截器")]),s._v("\nrequest."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("interceptors")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("response")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("use")]),s._v("(\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 响应成功进入第1个函数")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 该函数的参数是响应对象")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("response")]),s._v(") {\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Any status code that lie within the range of 2xx cause this function to trigger")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Do something with response data")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" response;\n  },\n  "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 响应失败进入第2个函数，该函数的参数是错误对象")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("error")]),s._v(") {\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Any status codes that falls outside the range of 2xx cause this function to trigger")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Do something with response error")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 如果响应码是 401 ，则请求获取新的 token")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 响应拦截器中的 error 就是那个响应的错误对象")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("dir")]),s._v("(error);\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (error."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("response")]),s._v(" && error."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("response")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("status")]),s._v(" === "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("401")]),s._v(") {\n      "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 校验是否有 refresh_token")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" user = store."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("state")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("user")]),s._v(";\n\n      "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("if")]),s._v(" (!user || !user."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("refresh_token")]),s._v(") {\n        router."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("push")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"/login"')]),s._v(");\n\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 代码不要往后执行了")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(";\n      }\n\n      "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 如果有refresh_token，则请求获取新的 token")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("try")]),s._v(" {\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" res = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("await")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("axios")]),s._v("({\n          "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("method")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"PUT"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("url")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"http://ttapi.research.itcast.cn/app/v1_0/authorizations"')]),s._v(",\n          "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("headers")]),s._v(": {\n            "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Authorization")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("`Bearer "),t("span",{pre:!0,attrs:{class:"hljs-subst"}},[s._v("${user.refresh_token}")]),s._v("`")]),s._v("\n          }\n        });\n\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 如果获取成功，则把新的 token 更新到容器中")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"刷新 token  成功"')]),s._v(", res);\n        store."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("commit")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"setUser"')]),s._v(", {\n          "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("token")]),s._v(": res."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("data")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("token")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 最新获取的可用 token")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("refresh_token")]),s._v(": user."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("refresh_token")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 还是原来的 refresh_token")]),s._v("\n        });\n\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 把之前失败的用户请求继续发出去")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// config 是一个对象，其中包含本次失败请求相关的那些配置信息，例如 url、method 都有")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// return 把 request 的请求结果继续返回给发请求的具体位置")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("request")]),s._v("(error."),t("span",{pre:!0,attrs:{class:"hljs-property"}},[s._v("config")]),s._v(");\n      } "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("catch")]),s._v(" (err) {\n        "),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// 如果获取失败，直接跳转 登录页")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"hljs-variable language_"}},[s._v("console")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("log")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"请求刷线 token 失败"')]),s._v(", err);\n        router."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("push")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"/login"')]),s._v(");\n      }\n    }\n\n    "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-title class_"}},[s._v("Promise")]),s._v("."),t("span",{pre:!0,attrs:{class:"hljs-title function_"}},[s._v("reject")]),s._v("(error);\n  }\n);\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("default")]),s._v(" request;\n")])])])])])}],_=r(3736),p={},v=(0,_.Z)(p,n,l,!1,null,null,null),c=v.exports,o={name:"tags-blog",components:{blogTags:c},data(){return{}},mounted(){},methods:{}},h=o,i=(0,_.Z)(h,a,e,!1,null,"1c9b330f",null),j=i.exports},3292:function(s,t,r){s.exports=r.p+"img/image-20200827155342126.80defbc3.png"}}]);
//# sourceMappingURL=897.c94496e1.js.map